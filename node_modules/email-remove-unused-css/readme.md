# email-remove-unused-css

<a href="https://github.com/revelt/eslint-on-airbnb-base-badge" style="float: right; padding: 0 0 20px 20px;"><img src="https://cdn.rawgit.com/revelt/eslint-on-airbnb-base-badge/0c3e46c9/lint-badge.svg" alt="ESLint on airbnb-base with caveats" width="100" align="right"></a>

> Remove unused CSS from email templates

[![Minimum Node version required][node-img]][node-url]
[![Link to npm page][npm-img]][npm-url]
[![Build Status][travis-img]][travis-url]
[![Coverage][cov-img]][cov-url]
[![bitHound Overall Score][overall-img]][overall-url]
[![bitHound Dependencies][deps-img]][deps-url]
[![View dependencies as 2D chart][deps2d-img]][deps2d-url]
[![bitHound Dev Dependencies][dev-img]][dev-url]
[![Known Vulnerabilities][vulnerabilities-img]][vulnerabilities-url]
[![Downloads/Month][downloads-img]][downloads-url]
[![Test in browser][runkit-img]][runkit-url]
[![MIT License][license-img]][license-url]

* Online web app: [EmailComb](https://emailcomb.com)
* Gulp plugin: [gulp-email-remove-unused-css](https://github.com/codsen/gulp-email-remove-unused-css/)
* PostHTML plugin: [posthtml-email-remove-unused-css](https://github.com/codsen/posthtml-email-remove-unused-css/)

## Table of Contents

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Install](#install)
- [Idea - updated for v.2](#idea---updated-for-v2)
- [API - new in v.2](#api---new-in-v2)
  - [API - Input](#api---input)
  - [API - Input - Options object](#api---input---options-object)
  - [API - Output](#api---output)
- [Input options.whitelist](#input-optionswhitelist)
- [Tapping the stream in Gulp](#tapping-the-stream-in-gulp)
- [Removing unused CSS from web pages & competition](#removing-unused-css-from-web-pages--competition)
- [Contributing](#contributing)
- [Licence](#licence)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

**[⬆ &nbsp;back to top](#)**

## Install

```bash
$ npm i email-remove-unused-css
```

Transpiled code (ES5) is served.

**[⬆ &nbsp;back to top](#)**

## Idea - updated for v.2

This library removes unused CSS from HTML. It is aimed for email HTML, which means there are peculiarities compared to web HTML:

* email code is expected to have **back-end code**: proprietary ESP markup or whatever backend code is used to set up the email campaign: from ExactTarget to MailChimp, from Java to Ruby, from Nunjucks to Moustache. This library has to play well with non-valid HTML. This means we can't use **HTML parsing** to remove unused CSS.
* this library will cope with **dirty code** well. As long as your CSS stays within `<style>` tags and within `class=`/`id=` attributes, this library **will not care about the validity of your HTML**. Missing `<html>`, unclosed `</table>` tags - no problemo! Use other tools to lint your code, but this library will not assume anything. There are other tools for HTML validation.
* Exceptions to _not-touching-the-HTML_ rule are the areas (and vicinity), directly related to CSS removal. For example, if you have CSS excessive whitespace within `class` attribute, it will be cleaned too. This tool _aims_ not to touch your HTML, but _where it does_ touch it, it will produce squeaky clean HTML (leaving the rest as it is).
* This tool fully supports `id` attributes and treats them as equals to classes.
* This tool will aim for maximum speed, and full-rewrite in the v.2 release is by magnitudes faster than v.1: it takes milliseconds to what previously took minutes. That's because all the job is done on the input string, **within three traversal loops**. There are no operations on objects or parsing, just plain ops on the string.

**[⬆ &nbsp;back to top](#)**

## API - new in v.2

```js
emailRemoveUnusedCss(htmlContentsAsString, [options])
```

**[⬆ &nbsp;back to top](#)**

### API - Input

Input argument         | Type    | Obligatory? | Description
-----------------------|---------|-------------|--------------------
`htmlContentsAsString` | String  | yes         | HTML code as string
options object         | Object  | no          | Any options, as a plain object, see below

For example,

```js
var html = '<html>zzz</html><body class="class-1">zzz</body>'
var result = emailRemoveUnusedCss(
  html,
  {
    whitelist: ['.class-1', '#id-1', '.module-*']
  }
)
console.log('result = ' + JSON.stringify(result, null, 4))
```

**[⬆ &nbsp;back to top](#)**

### API - Input - Options object

Optionally, you can pass the options array:

Options object's key  | Type    | Example                            | Description
----------------------|---------|------------------------------------|-----------------
`whitelist`           | Array   | ['.class-1', '#id-1', '.module-*'] | List all classes or id's you want this library to ignore

### API - Output

Since v.2 a plain object is returned with keys:

Info object's key | Type    | Description
------------------|---------|-----------------
`result`          | String  | A string containing cleaned HTML
`allInHead`       | Array   | Deduped and sorted array of all classes and id's between `<head>` tags
`allInBody`       | Array   | Deduped and sorted array of all classes and id's between `<body>` tags
`deletedFromHead` | Array   | Array of classes/id's that were deleted inside `<head>` _at least once_^
`deletedFromBody` | Array   | Array of classes/id's that were deleted inside `<body>` _at least once_^

^ Some legit, used classes/id's might be "sandwiched" with unused-ones (like `.head-only.real-class`) and deleted in some `<style>` tags, but not in all. This is a rare case, added in [v1.12](https://github.com/codsen/email-remove-unused-css/releases/tag/v1.12.0).

## Input options.whitelist

Since the main purpose of this library is to clean **email** HTML, it needs to cater for email code specifics. One of them is that CSS styles will contain fix or hack styles, meant for email software. For example, here are few of them:

```html
#outlook a { padding:0; }
.ExternalClass, .ReadMsgBody { width:100%; }
.ExternalClass, .ExternalClass div, .ExternalClass font, .ExternalClass p, .ExternalClass span, .ExternalClass td { line-height:100%; }
```

Obviously, you will not be using the above classes, and id's in the `<body>` of your HTML code, what means they would get removed — they are present in `<head>` only. To avoid that, pass the classes and id's in the _whitelist_ key's value, as an array, for example:

```js
var html = '<!DOCTYPE html>...'
emailRemoveUnusedCss(html,
  {
    whitelist: ['#outlook', '.ExternalClass', '.ReadMsgBody']
  }
)
```

You can also use a _wildcard_, for example in order to whitelist classes `module-1`, `module-2` ... `module-99`, `module-100`, you can simply whitelist them as `module-*`:

```js
var html = '<!DOCTYPE html>...'
emailRemoveUnusedCss(html,
  {
    whitelist: ['.module-*']
  }
)
// => all class names that begin with ".module-" will not be touched by this library.
```

**[⬆ &nbsp;back to top](#)**

## Tapping the stream in Gulp

In Gulp, everything flows as a vinyl Buffer streams. You could [tap](https://github.com/geejs/gulp-tap) the stream, convert it to `string`, perform the operations (like remove unused CSS), then convert it back to Buffer and place the stream back. I wanted to come up with a visual analogy example using waste pipes but thought I'd rather won't.

Code-wise, here's the idea:

```js
const tap = require('gulp-tap')
const removeUnused = require('email-remove-unused-css')
const util = require('gulp-util')
const whitelist = ['.External*', '.ReadMsgBody', '.yshortcuts', '.Mso*', '#outlook', '.module*']

gulp.task('build', () => {
  return gulp.src('emails/*.html')
    .pipe(tap((file) => {
      const cleanedHtmlResult = removeUnused(file.contents.toString(), { whitelist })
      util.log(util.colors.green(`\nremoved ${cleanedHtmlResult.deletedFromHead.length} from head: ${cleanedHtmlResult.deletedFromHead.join(' ')}`))
      util.log(util.colors.green(`\nremoved ${cleanedHtmlResult.deletedFromBody.length} from body: ${cleanedHtmlResult.deletedFromBody.join(' ')}`))
      file.contents = Buffer.from(cleanedHtmlResult.result)
    }))
})
```

**[⬆ &nbsp;back to top](#)**

## Removing unused CSS from web pages & competition

This library is meant to be used on any HTML where there are **no external CSS stylesheets**. It's quite rare to find a **web page** that would have no external stylesheets, but 100% of **email newsletters** are like that and this library suits them perfectly.

**[⬆ &nbsp;back to top](#)**

## Contributing

Hi! 99% of society are passive people, consumers. They wait for others to take action, they prefer to blend in. Rest 1% are proactive, vocal (usually also opinionated) citizens who will _do_ something rather than _wait_, hoping others will do it eventually. If you are one of that 1 %, you're in luck because I am the same and together we can make something happen.

* If you want a new feature in this package or you would like to change some of its functionality, raise an [issue on this repo](https://github.com/codsen/email-remove-unused-css/issues). Also, you can [email me](mailto:roy@codsen.com).

* If you tried to use this library but it misbehaves, or you need an advice setting it up, and its readme doesn't make sense, just document it and raise an [issue on this repo](https://github.com/codsen/email-remove-unused-css/issues). Alternatively, you can [email me](mailto:roy@codsen.com).

* I know it never happens, but if you don't like the code in here and would like to criticize it, please do. Same drill - [GitHub issues](https://github.com/codsen/email-remove-unused-css/issues) or [email](mailto:roy@codsen.com), your choice.

## Licence

MIT License (MIT)

Copyright © 2017 Codsen Ltd, Roy Revelt

[node-img]: https://img.shields.io/node/v/email-remove-unused-css.svg?style=flat-square&label=works%20on%20node
[node-url]: https://www.npmjs.com/package/email-remove-unused-css

[npm-img]: https://img.shields.io/npm/v/email-remove-unused-css.svg?style=flat-square&label=release
[npm-url]: https://www.npmjs.com/package/email-remove-unused-css

[travis-img]: https://img.shields.io/travis/codsen/email-remove-unused-css.svg?style=flat-square
[travis-url]: https://travis-ci.org/codsen/email-remove-unused-css

[cov-img]: https://coveralls.io/repos/github/codsen/email-remove-unused-css/badge.svg?style=flat-square?branch=master
[cov-url]: https://coveralls.io/github/codsen/email-remove-unused-css?branch=master

[overall-img]: https://img.shields.io/bithound/code/github/codsen/email-remove-unused-css.svg?style=flat-square
[overall-url]: https://www.bithound.io/github/codsen/email-remove-unused-css

[deps-img]: https://img.shields.io/bithound/dependencies/github/codsen/email-remove-unused-css.svg?style=flat-square
[deps-url]: https://www.bithound.io/github/codsen/email-remove-unused-css/master/dependencies/npm

[deps2d-img]: https://img.shields.io/badge/deps%20in%202D-see_here-08f0fd.svg?style=flat-square
[deps2d-url]: http://npm.anvaka.com/#/view/2d/email-remove-unused-css

[dev-img]: https://img.shields.io/bithound/devDependencies/github/codsen/email-remove-unused-css.svg?style=flat-square
[dev-url]: https://www.bithound.io/github/codsen/email-remove-unused-css/master/dependencies/npm

[vulnerabilities-img]: https://snyk.io/test/github/codsen/email-remove-unused-css/badge.svg?style=flat-square
[vulnerabilities-url]: https://snyk.io/test/github/codsen/email-remove-unused-css

[downloads-img]: https://img.shields.io/npm/dm/email-remove-unused-css.svg?style=flat-square
[downloads-url]: https://npmcharts.com/compare/email-remove-unused-css

[runkit-img]: https://img.shields.io/badge/runkit-test_in_browser-a853ff.svg?style=flat-square
[runkit-url]: https://npm.runkit.com/email-remove-unused-css

[license-img]: https://img.shields.io/npm/l/email-remove-unused-css.svg?style=flat-square
[license-url]: https://github.com/codsen/email-remove-unused-css/blob/master/license.md
